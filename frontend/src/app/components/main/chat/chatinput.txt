import { useState } from "react";
import { auth, db } from '../../../config/firebase';
import { doc, updateDoc, serverTimestamp } from "firebase/firestore";
import { createMessage } from "../api/create.js";


export function ChatInput({ChatLog} : {ChatLog : string}) {
  const [text, setText] = useState('');
  // const [messages, setMessages] = useState("");

  const handleMessage = (e: React.FormEvent) => {
    e.preventDefault();
    if (text.trim() === "") return;
    handleMessageSubmit();
    setText("");
  }

  function generateUniqueId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2, 8);
  }

  const messagesDoc = doc(db, "messages", ChatLog,"chatlog", "chatlog");
  const handleMessageSubmit = async () => {

    const uniqueId = generateUniqueId();

    const newMessage = {
      [uniqueId]: {
        text: text,
        time: serverTimestamp(),
        userID: auth.currentUser?.uid,
        userName: auth.currentUser?.displayName,
        id: uniqueId
      }
    }

    const newMessageAPI = {
      text: text,
      userName: auth.currentUser?.displayName,
    }

    createMessage(newMessageAPI)
    try {
      await updateDoc(messagesDoc, newMessage)
    } catch (err) {
      console.log(err)
    }
  }

  return (
    <form className="main-message fix" onSubmit={handleMessage}>
      <input
        className="input message-input"
        placeholder="Type Message..."
        onChange={(event) => setText(event.target.value)}
        value={text}
      ></input>
      <button className="button message-send">Send</button>
    </form>
  )
}
